<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.8.0">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="「等我想好简介了就会把这里填上的。」">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      活在梦里的项目一览【二】 | Cowsay&#39;s Log
    
  </title>
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  
  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>
  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


</head>
<div class="wechat-share">
  <img src="/css/images/logo.png">
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Cowsay's Log</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>活在梦里的项目一览【二】</h2>
  <p class="post-date">2018-09-24</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p>我曾经计划过多个C++实用库，目前还能记得的有两个，libdough和libnever。</p>
<a id="more"></a>
<p>libdough（dough：面团）是一个非常早期的想法了，大约可以追溯至两个冬天以前。当时沉迷于链式调用的我试图写一个可以无穷无尽「链」下去的函数库，类似于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">File(&apos;something.txt&apos;).read().split(&apos;\n&apos;) -&gt; t1</span><br><span class="line">t1.filter(line =&gt; line.length &gt; 10) -&gt; t2</span><br><span class="line">t1.append(&apos;And those long line: &apos;).extend(t2).write(File(&apos;something_copy.txt&apos;))</span><br></pre></td></tr></table></figure>
<p>总之就是很无聊的一个东西。这个库应该不会写了，因为(1)作为C++库我有了一个更好的想法；(2)作为链式调用我有了一个更好的想法。不过，这其中包含了一个有趣的观点：现在的编程语言大多是将逻辑「纵向」切开的，将代码逻辑以变量为单位进行分割，每个变量随着时间的推移，其值发生变化并且与其他变量发生交互；libdough希望将代码逻辑以某一瞬间的「状态」为单位将其「横向」切开，比如上面的<code>t1</code>和<code>t2</code>，理论上它们每一个都可以包含某一瞬间程序状态的全部信息。程序运行的方式类似于「揉面团」：无论什么时候，整个程序都是一个大面团，你可以对其执行一个整体的操作，是它从「被揉了n下的面团」转变为「被揉了n+1下的面团」。这种抽象也许在并发和副作用处理等方面具有优势，但是年代久远我已经不太记得了。</p>
<hr>
<p>关于C++库的「更好的想法」：libnever。这里的never是「never return」的意思（同时也是这个库我永远都写不出来的意思），这是一个CPS风格的实用库，其中所有的函数都不返回。为了得到函数运行的结果，用户需要多传进去一个回调函数，libnever会以函数的结果为参数调用这个回调函数。有关于CPS的优劣就不需要我来分析了，总之写出这个代码库本身也是非常好玩的。</p>
<p>这个项目在上个秋天被我认认真真地进行了一个月，期间由于我在<a href="!--￼3--">「认真写博客」（续）</a>当中描述的态度缺陷，非常理所当然地找错了重点，最后研究出来这么一个<a href="https://github.com/lifta42/lib-never/blob/dev/proof/standarize7.cpp" target="_blank" rel="noopener">代码文件</a>，截取它最后测试的一段：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  stand([](<span class="keyword">int</span> &amp;&amp;x, <span class="keyword">int</span> &amp;&amp;y, Cont&lt;<span class="keyword">int</span>&gt; pass) &#123; pass(x + y); &#125;,</span><br><span class="line">        [](<span class="keyword">auto</span> &amp;&amp;proc) &#123;</span><br><span class="line">          proc(<span class="number">3</span>, [](<span class="keyword">auto</span> &amp;&amp;proc) &#123;</span><br><span class="line">            proc(<span class="number">5</span>, [](<span class="keyword">int</span> &amp;&amp;eight) &#123; <span class="built_in">cout</span> &lt;&lt; eight &lt;&lt; <span class="built_in">endl</span>; &#125;);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不管它是什么意思，反正它已经把代码高亮搞死了。事实上，<code>stand</code>接受两个参数，第一个参数是一个CPS风格的函数，这个函数可以带有任意多个输入参数和一个输出的回调函数参数，<code>stand</code>会将其科里化……对没错，科里化，然后返回给第二个参数的回调函数。可以看到，上面例子当中的两个<code>proc</code>都只接受两个参数了，一个输入一个输出。而最终，就像变量名预示的那样，这个程序会打印一个8在屏幕上。如果<code>stand</code>是一个动态语言写成的函数，那么大约十几行就能写好；可是这里是C++，并且这里没有出现任何多余的类型声明！说实话，写完这个代码文件，我真的已经膨胀到想宣称自己「精通C++元编程」了……同时再也不想碰模板元编程了。</p>
<hr>
<p>其实，最能让我浮想联翩的领域，是且只会是——编译器。「自制一门编程语言，并在3~5年内让全世界的程序员都用上它」这一意淫，千变万化地出现在我大量的点子当中。</p>
<p>说到编译器第一个想到的是什么？没错，LISP！说来有趣，我开始写LISP解释器的契机还要更无厘头一点。在一节昏昏欲睡的马克思课堂上，友人像我抱怨他参加的某编程竞赛的题目是「写一个最小化的LISP解释器」，难得要死。我表示「这不是非常简单吗？」（你看我又在轻视他人了……不过看过SICP的我这么说也不算特别过分啦），然后在那节课上想清楚了各种边边角角，并在接下来花了两个小时写了一个符合竞赛要求的解释器出来。所以我怎么就没去比赛呢……</p>
<p>这个项目曾经有个代号futaba，来源是宫水二叶的名字，因为我还打算在它之上再用LISP写一个能自举的LISP编译器并起名为宫水三叶的名字……不记得了。不过后来被人取笑名字里有个「扶她」（这不是很正常！futa本来就是「二」的意思啊！「二叶」和「双性人」都有个「二」所以都有个futa有什么问题吗？！」，于是改名叫amplifier了。原本打算照着R<sup>7</sup>RS实现一个出来，后来发现就自己这半吊子水平，想把规范看懂可真是有点难度……</p>
<p>最近的一个想法是，和另外一个点子，「制作一份SICP的习题解」结合起来。一边做题，一边做解释器，岂不是美滋滋。这样做其实是有实际的好处的，因为第三章的题目涉及到的画图函数并没有被任何一个LISP解释器实现（<del>如果有</del>如果有人在看这篇文章&amp;&amp;知道有哪个解释器实现了画图函数请务必告诉我谢谢），然而时代早已风云变幻（「是时候做出选择了，哥哥！」），输出一个svg格式的文件然后让用户到Chrome里去预览可以说是在实现复杂度和用户体验之间的一个足够优雅的平衡点。不过SICP被我借给学弟了，算是一个万幸存在的合理理由阻止我在这个项目上浪费光阴……</p>
<hr>
<p>在「两个小时写出来的解释器」和「最近的一个想法」之间，便是「更好的链式调用」：……宫水三叶！</p>
<p>其实我一开始并没有把它当做链式调用来写，只是在改进futaba的过程中开始嫌弃LISP的语法和语言特性太臃肿了（……嫌弃LISP太臃肿？你还是人吗），于是开始思考一门编程语言到底可以有多小。最终得到了一门语言，它只有一种类型的变量，我称之为piece。一个piece可以看作一个函数，这个函数接受一个piece作为参数并返回一个piece作为结果。这个想法还是非常有意思和拓展的意义的，可惜我又搞错了重点：我开始苦苦探索一种不加括号就可以确定piece之间结合顺序的语法……想不出来就先不要做前端就好了嘛，反正过个几十年编译器前端都是直接从脑电波翻译语法树了。总之，试着写了一下以后我发现，这不就是语言层面上的libdough嘛！事实上，由于它在语言层面上，它还可以消除惰性求值和严格求值之间的沟壑，同步代码和异步代码之间的沟壑（是的，看来libnever也可以集成进来了），是一个在实验层面上非常有意义的玩具，换言之……可能早就有人写过了。</p>
<p>作为这一篇的结尾，放一段三叶的代码。我真的没有想到自己曾经想过的点子居然两篇文章都写不完，看来过去的几年间，我的精神食粮毫不夸张地把自己喂成了一个好吃懒做的人。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">; futaba_test.ftb</span><br><span class="line">; A playground for testing Futaba&apos;s features.</span><br><span class="line"></span><br><span class="line">; main</span><br><span class="line">`put `+ `- `* `/ `&lt; `= `then `Y `cons `car `cdr</span><br><span class="line">  `print-range</span><br><span class="line">    `[A `Z)</span><br><span class="line">      print-range [A Z) then put 10</span><br><span class="line">    .. 65, 65 + 26</span><br><span class="line">  ., ; print-range</span><br><span class="line">  Y `self `n `m</span><br><span class="line">    `keep</span><br><span class="line">      n &lt; m ? keep 0</span><br><span class="line">    .,</span><br><span class="line">    ; keep</span><br><span class="line">    n + 1, `n1</span><br><span class="line">    `next&amp; next&amp;, self n1 m., `next</span><br><span class="line">      put n then next</span><br><span class="line">    ..</span><br><span class="line">  ...</span><br><span class="line">............</span><br><span class="line"></span><br><span class="line">; put + - * / &lt; =</span><br><span class="line">`x x put.</span><br><span class="line">`a `b b, a +..</span><br><span class="line">`a `b b, a -..</span><br><span class="line">`a `b b, a *..</span><br><span class="line">`a `b b, a /..</span><br><span class="line">`a `b b, a &lt;..</span><br><span class="line">`a `b b, a =..</span><br><span class="line"></span><br><span class="line">; then</span><br><span class="line">`x `y y..</span><br><span class="line"></span><br><span class="line">; Y</span><br><span class="line">`f</span><br><span class="line">  `x f, x x.</span><br><span class="line">  `x f, x x.</span><br><span class="line">.</span><br><span class="line"></span><br><span class="line">; cons car cdr</span><br><span class="line">`h `t `f f h t...</span><br><span class="line">`l l `h `t h.. .</span><br><span class="line">`l l `h `t t.. .</span><br><span class="line"></span><br><span class="line">.</span><br></pre></td></tr></table></figure>
<p>一个piece被定义为一个反引号和一个形式参数名开始，到一个句号结束。在piece的后面写另一个piece就是调用的意思。这里可以看到我把各种基本运算都重新定义了一遍，这其实就是由于结合顺序没有做好（大概和逗号的使用有关）所导致的应急解决方案。这篇代码包含了「Y结合子」「基于lambda的列表」等诸多炫技操作，当年我大概也是个狂妄无知的少年吧。</p>
<blockquote>
<p>说得好像你现在就不是了一样。</p>
</blockquote>
<p>有关这篇代码的详细解释可以看看<a href="https://zhuanlan.zhihu.com/p/31297729" target="_blank" rel="noopener">这里</a>。</p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#人话">
    <span class="tag-code">人话</span>
  </a>

  <a href="/tags#计划">
    <span class="tag-code">计划</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2018/09/23/2018-9-24-【翻译】最小化的tmux教程/">
        <span class="nav-arrow">← </span>
        
          【翻译】一个最小化的tmux基础教程
        
      </a>
    
    
      <a class="nav-right" href="/2018/09/25/2018-9-25-一条流的基本素养/">
        
          【stream】起步-一条流的基本素养
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
    <!-- 二维码 END -->
    
      <!-- No Comment -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'https://whoiscc.github.io/2018/09/23/2018-9-24-活在梦里的项目一览（二）/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>







    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2019 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->

<script src="/js/script.js"></script>
  </body>
</html>